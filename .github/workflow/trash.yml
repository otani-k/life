name: create trash issue

on:
  schedule:
    - cron: '0 20 * * *' # JST 5:00 = UTC 20:00
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GH_PAT }}
      OWNER: your-name
      REPO: your-repo
      PROJECT_NUMBER: 1        # Projects v2 ã®ç•ªå·
      ISSUE_TITLE: ã‚´ãƒŸã‚’æ¨ã¦ã‚‹
      TARGET_COLUMN: "@å®¶"

    steps:
      - uses: actions/checkout@v4

      - name: Check project and create issue if needed
        run: |
          node <<'EOF'
          const fetch = (...args) => import('node-fetch').then(({default: fetch}) => fetch(...args));

          const {
            GH_TOKEN,
            OWNER,
            REPO,
            PROJECT_NUMBER,
            ISSUE_TITLE,
            TARGET_COLUMN
          } = process.env;

          const headers = {
            Authorization: `Bearer ${GH_TOKEN}`,
            "Content-Type": "application/json"
          };

          async function graphql(query, variables = {}) {
            const res = await fetch("https://api.github.com/graphql", {
              method: "POST",
              headers,
              body: JSON.stringify({ query, variables })
            });
            return res.json();
          }

          // 1. Project æƒ…å ±å–å¾—
          const projectRes = await graphql(`
            query($login: String!, $number: Int!) {
              user(login: $login) {
                projectV2(number: $number) {
                  id
                  items(first: 100) {
                    nodes {
                      content {
                        ... on Issue {
                          title
                        }
                      }
                      fieldValues(first: 10) {
                        nodes {
                          ... on ProjectV2ItemFieldSingleSelectValue {
                            name
                          }
                        }
                      }
                    }
                  }
                }
              }
            }
          `, { login: OWNER, number: Number(PROJECT_NUMBER) });

          const items = projectRes.data.user.projectV2.items.nodes;

          const exists = items.some(item => {
            const title = item.content?.title;
            const columns = item.fieldValues.nodes.map(v => v.name);
            return title === ISSUE_TITLE && columns.includes(TARGET_COLUMN);
          });

          if (exists) {
            console.log("æ—¢ã« @å®¶ ã«å­˜åœ¨ã™ã‚‹ãŸã‚ issue ã¯ä½œæˆã—ã¾ã›ã‚“");
            return;
          }

          // 2. Issue ä½œæˆ
          const res = await fetch(`https://api.github.com/repos/${OWNER}/${REPO}/issues`, {
            method: "POST",
            headers,
            body: JSON.stringify({
              title: ISSUE_TITLE,
              body: "æ¯æœã®å®šæœŸã‚¿ã‚¹ã‚¯ ğŸ—‘ï¸"
            })
          });

          if (!res.ok) {
            console.error(await res.text());
            process.exit(1);
          }

          console.log("issue ã‚’ä½œæˆã—ã¾ã—ãŸ");
          EOF
